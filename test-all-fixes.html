<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeSciä¿®å¤éªŒè¯é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { border-color: #4CAF50; background-color: #f8fff8; }
        .error { border-color: #f44336; background-color: #fff8f8; }
        .warning { border-color: #ff9800; background-color: #fffef8; }
        .info { border-color: #2196F3; background-color: #f8faff; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-info { background: #9c27b0; color: white; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; max-height: 200px; }
        .summary { background: #e3f2fd; padding: 15px; border-radius: 5px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ğŸš€ DeSciå¹³å°ä¿®å¤éªŒè¯</h1>

    <div class="summary">
        <h3>âœ… å·²ä¿®å¤çš„é—®é¢˜</h3>
        <ul>
            <li><strong>Ethers.jsåŠ è½½é—®é¢˜</strong> - æ·»åŠ äº†å¤šé‡å¤‡ç”¨åŠ è½½ç­–ç•¥</li>
            <li><strong>åˆçº¦è°ƒç”¨è§£ç é”™è¯¯</strong> - ä½¿ç”¨Promise.allSettledå¤„ç†å¤±è´¥</li>
            <li><strong>Gasä»·æ ¼è·å–å¤±è´¥</strong> - æ·»åŠ äº†getFeeDataå¤‡ç”¨æ–¹æ³•</li>
            <li><strong>æ¼”ç¤ºè„šæœ¬bindé”™è¯¯</strong> - ä¿®å¤äº†æ–¹æ³•åç§°ä¸åŒ¹é…</li>
            <li><strong>ç”¨æˆ·æ¡£æ¡ˆæ£€æŸ¥å¤±è´¥</strong> - æ·»åŠ äº†å®Œå–„çš„é”™è¯¯å¤„ç†</li>
        </ul>
    </div>

    <div id="ethers-test" class="test-section success">
        <h3>ğŸ”— Ethers.js åŠ è½½çŠ¶æ€</h3>
        <div id="ethers-status">æ­£åœ¨æ£€æŸ¥...</div>
        <button onclick="testEthers()">é‡æ–°æµ‹è¯• Ethers.js</button>
    </div>

    <div id="contract-test" class="test-section info">
        <h3>ğŸ“‹ åˆçº¦è°ƒç”¨æµ‹è¯•</h3>
        <div id="contract-status">ç­‰å¾…æµ‹è¯•...</div>
        <button onclick="testContracts()">æµ‹è¯•åˆçº¦è°ƒç”¨</button>
    </div>

    <div id="provider-test" class="test-section warning">
        <h3>ğŸŒ Provider æµ‹è¯•</h3>
        <div id="provider-status">ç­‰å¾…æµ‹è¯•...</div>
        <button onclick="testProvider()">æµ‹è¯• Provider</button>
    </div>

    <div id="demo-test" class="test-section success">
        <h3>ğŸ¬ æ¼”ç¤ºè„šæœ¬æµ‹è¯•</h3>
        <div id="demo-status">ç­‰å¾…æµ‹è¯•...</div>
        <button onclick="testDemoScript()">æµ‹è¯•æ¼”ç¤ºè„šæœ¬</button>
    </div>

    <div id="comprehensive-test" class="test-section info">
        <h3>ğŸ” ç»¼åˆæµ‹è¯•</h3>
        <div id="comprehensive-status">ç­‰å¾…æµ‹è¯•...</div>
        <button onclick="runComprehensiveTest()">è¿è¡Œç»¼åˆæµ‹è¯•</button>
    </div>

    <div id="results" class="test-section">
        <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
        <pre id="test-results">æš‚æ— æµ‹è¯•ç»“æœ</pre>
    </div>

    <!-- Ethers.js Library with Robust Fallback -->
    <script>
        // æ£€æµ‹æ˜¯å¦å·²æœ‰ethers.js
        if (typeof window.ethers !== 'undefined') {
            console.log('Ethers.js already loaded');
            updateTestStatus('ethers-test', 'success', 'Ethers.js å·²åŠ è½½');
        } else {
            // ä½¿ç”¨å¼‚æ­¥åŠ è½½é¿å…document.writeé˜»å¡
            console.log('Loading ethers.js from CDN...');
            updateTestStatus('ethers-test', 'warning', 'æ­£åœ¨åŠ è½½ Ethers.js...');
            loadEthersFromCDN();
        }

        function loadEthersFromCDN() {
            var script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/ethers/6.8.0/ethers.umd.min.js';
            script.onload = function() {
                console.log('Ethers.js loaded from CDN successfully');
                window.ethersLoaded = true;
                updateTestStatus('ethers-test', 'success', 'Ethers.js å·²ä» CDN åŠ è½½æˆåŠŸ');
            };
            script.onerror = function() {
                console.warn('CDN ethers.js failed, trying alternative...');
                updateTestStatus('ethers-test', 'warning', 'CDN åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ CDN...');
                loadEthersAlternative();
            };
            document.head.appendChild(script);
        }

        function loadEthersAlternative() {
            var script = document.createElement('script');
            script.src = 'https://unpkg.com/ethers@6.8.0/dist/ethers.umd.min.js';
            script.onload = function() {
                console.log('Ethers.js loaded from alternative CDN successfully');
                window.ethersLoaded = true;
                updateTestStatus('ethers-test', 'success', 'Ethers.js å·²ä»å¤‡ç”¨ CDN åŠ è½½æˆåŠŸ');
            };
            script.onerror = function() {
                console.warn('Alternative CDN failed, using local fallback...');
                updateTestStatus('ethers-test', 'warning', 'å¤‡ç”¨ CDN ä¹Ÿå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ–‡ä»¶...');
                loadEthersLocal();
            };
            document.head.appendChild(script);
        }

        function loadEthersLocal() {
            var script = document.createElement('script');
            script.src = 'ethers-local.umd.min.js';
            script.onload = function() {
                console.log('Ethers.js loaded from local file successfully');
                window.ethersLoaded = true;
                updateTestStatus('ethers-test', 'success', 'Ethers.js å·²ä»æœ¬åœ°æ–‡ä»¶åŠ è½½æˆåŠŸ');
            };
            script.onerror = function() {
                console.error('All ethers.js loading methods failed!');
                window.ethersLoaded = false;
                updateTestStatus('ethers-test', 'error', 'æ‰€æœ‰åŠ è½½æ–¹æ³•éƒ½å¤±è´¥äº†ï¼');
            };
            document.head.appendChild(script);
        }

        function updateTestStatus(testId, status, message) {
            const element = document.getElementById(testId);
            const statusDiv = element.querySelector('div');

            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            element.className = element.className.replace(/\b(success|error|warning|info)\b/g, '');
            element.classList.add(status);

            statusDiv.innerHTML = message;
        }

        function testEthers() {
            let result = 'ğŸ” Ethers.js æµ‹è¯•ç»“æœ:\n\n';

            if (typeof window.ethers === 'undefined') {
                result += 'âŒ Ethers.js æœªåŠ è½½\n';
                updateTestStatus('ethers-test', 'error', 'Ethers.js æœªåŠ è½½');
                return;
            }

            result += 'âœ… Ethers.js å·²åŠ è½½\n';
            result += `ç‰ˆæœ¬: ${window.ethers.version || 'unknown'}\n`;
            result += `BrowserProvider: ${typeof window.ethers.BrowserProvider}\n`;
            result += `Contract: ${typeof window.ethers.Contract}\n`;
            result += `formatUnits: ${typeof window.ethers.formatUnits}\n`;
            result += `parseUnits: ${typeof window.ethers.parseUnits}\n`;

            updateTestStatus('ethers-test', 'success', 'Ethers.js æµ‹è¯•é€šè¿‡');
            document.getElementById('test-results').textContent = result;
        }

        async function testProvider() {
            try {
                updateTestStatus('provider-test', 'warning', 'æ­£åœ¨æµ‹è¯• Provider...');

                if (!window.ethereum) {
                    updateTestStatus('provider-test', 'error', 'æœªæ£€æµ‹åˆ° MetaMask æˆ–å…¶ä»– Web3 é’±åŒ…');
                    return;
                }

                const provider = new window.ethers.BrowserProvider(window.ethereum);
                const network = await provider.getNetwork();
                const blockNumber = await provider.getBlockNumber();

                updateTestStatus('provider-test', 'success', `
                    <strong>Provider æµ‹è¯•æˆåŠŸ!</strong><br>
                    ç½‘ç»œ: ${network.name} (${network.chainId})<br>
                    å½“å‰åŒºå—: ${blockNumber}
                `);

                window.testProvider = provider;
            } catch (error) {
                updateTestStatus('provider-test', 'error', `Provider æµ‹è¯•å¤±è´¥: ${error.message}`);
                console.error('Provider test error:', error);
            }
        }

        async function testContracts() {
            try {
                updateTestStatus('contract-test', 'warning', 'æ­£åœ¨æµ‹è¯•åˆçº¦è°ƒç”¨...');

                if (!window.testProvider) {
                    updateTestStatus('contract-test', 'error', 'è¯·å…ˆè¿è¡Œ Provider æµ‹è¯•');
                    return;
                }

                // æ¨¡æ‹Ÿåˆçº¦åœ°å€ï¼ˆå®é™…æµ‹è¯•ä¸­åº”è¯¥ä½¿ç”¨çœŸå®çš„åˆçº¦åœ°å€ï¼‰
                const mockContractAddress = '0x5FbDB2315678afecb367f032d93F642f64180aa3';
                const mockAbi = [
                    {
                        "inputs": [],
                        "name": "getTotalUsers",
                        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                        "stateMutability": "view",
                        "type": "function"
                    }
                ];

                const contract = new window.ethers.Contract(mockContractAddress, mockAbi, window.testProvider);

                // æµ‹è¯•åˆçº¦è°ƒç”¨ï¼ˆè¿™å¯èƒ½ä¼šå¤±è´¥ï¼Œä½†æˆ‘ä»¬æƒ³è¦æµ‹è¯•é”™è¯¯å¤„ç†ï¼‰
                try {
                    const result = await contract.getTotalUsers();
                    updateTestStatus('contract-test', 'success', `åˆçº¦è°ƒç”¨æˆåŠŸ: ${result}`);
                } catch (contractError) {
                    updateTestStatus('contract-test', 'warning', `åˆçº¦è°ƒç”¨å¤±è´¥ï¼ˆå¦‚é¢„æœŸï¼‰: ${contractError.message}<br><small>è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºæµ‹è¯•ä½¿ç”¨çš„æ˜¯æ¨¡æ‹Ÿåœ°å€</small>`);
                }

            } catch (error) {
                updateTestStatus('contract-test', 'error', `åˆçº¦æµ‹è¯•å¤±è´¥: ${error.message}`);
                console.error('Contract test error:', error);
            }
        }

        function testDemoScript() {
            try {
                updateTestStatus('demo-test', 'warning', 'æ­£åœ¨æµ‹è¯•æ¼”ç¤ºè„šæœ¬...');

                // æ£€æŸ¥æ¼”ç¤ºç±»æ˜¯å¦å­˜åœ¨
                if (typeof DeSciDemo === 'undefined') {
                    updateTestStatus('demo-test', 'error', 'DeSciDemo ç±»æœªæ‰¾åˆ°');
                    return;
                }

                // åˆ›å»ºæ¼”ç¤ºå®ä¾‹
                const demo = new DeSciDemo();

                // æ£€æŸ¥å¿…è¦çš„æ–¹æ³•
                const requiredMethods = ['startDemo', 'stopDemo', 'runDemoSequence', 'getStatus'];
                const missingMethods = requiredMethods.filter(method => typeof demo[method] !== 'function');

                if (missingMethods.length > 0) {
                    updateTestStatus('demo-test', 'error', `ç¼ºå°‘æ–¹æ³•: ${missingMethods.join(', ')}`);
                    return;
                }

                updateTestStatus('demo-test', 'success', 'æ¼”ç¤ºè„šæœ¬æµ‹è¯•é€šè¿‡ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½å­˜åœ¨');

            } catch (error) {
                updateTestStatus('demo-test', 'error', `æ¼”ç¤ºè„šæœ¬æµ‹è¯•å¤±è´¥: ${error.message}`);
                console.error('Demo script test error:', error);
            }
        }

        async function runComprehensiveTest() {
            updateTestStatus('comprehensive-test', 'warning', 'æ­£åœ¨è¿è¡Œç»¼åˆæµ‹è¯•...');

            let results = [];
            let passed = 0;
            let total = 4;

            // æµ‹è¯•1: Ethers.js
            if (typeof window.ethers !== 'undefined') {
                results.push('âœ… Ethers.js åŠ è½½æˆåŠŸ');
                passed++;
            } else {
                results.push('âŒ Ethers.js åŠ è½½å¤±è´¥');
            }

            // æµ‹è¯•2: Provider
            try {
                if (window.ethereum) {
                    const provider = new window.ethers.BrowserProvider(window.ethereum);
                    await provider.getNetwork();
                    results.push('âœ… Provider åˆ›å»ºæˆåŠŸ');
                    passed++;
                } else {
                    results.push('âš ï¸ æœªæ£€æµ‹åˆ°Web3é’±åŒ…');
                }
            } catch (error) {
                results.push('âŒ Provider åˆ›å»ºå¤±è´¥');
            }

            // æµ‹è¯•3: æ¼”ç¤ºè„šæœ¬
            if (typeof DeSciDemo !== 'undefined') {
                results.push('âœ… æ¼”ç¤ºè„šæœ¬åŠ è½½æˆåŠŸ');
                passed++;
            } else {
                results.push('âŒ æ¼”ç¤ºè„šæœ¬åŠ è½½å¤±è´¥');
            }

            // æµ‹è¯•4: åˆçº¦å¯¹è±¡
            if (typeof window.ethers !== 'undefined' && typeof window.ethers.Contract !== 'undefined') {
                results.push('âœ… åˆçº¦ç±»å¯ç”¨');
                passed++;
            } else {
                results.push('âŒ åˆçº¦ç±»ä¸å¯ç”¨');
            }

            const summary = `ç»¼åˆæµ‹è¯•å®Œæˆ: ${passed}/${total} é¡¹é€šè¿‡\n\n` + results.join('\n');
            document.getElementById('test-results').textContent = summary;

            if (passed === total) {
                updateTestStatus('comprehensive-test', 'success', `ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡! (${passed}/${total})`);
            } else if (passed >= total * 0.75) {
                updateTestStatus('comprehensive-test', 'warning', `âš ï¸ å¤§éƒ¨åˆ†æµ‹è¯•é€šè¿‡ (${passed}/${total})`);
            } else {
                updateTestStatus('comprehensive-test', 'error', `âŒ æµ‹è¯•å¤±è´¥è¿‡å¤š (${passed}/${total})`);
            }
        }

        // è‡ªåŠ¨è¿è¡ŒåŸºæœ¬æµ‹è¯•
        setTimeout(function() {
            if (typeof window.ethers !== 'undefined') {
                testEthers();
            }
        }, 1000);
    </script>
</body>
</html>
